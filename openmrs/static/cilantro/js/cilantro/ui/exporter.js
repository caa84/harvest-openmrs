define(["jquery","underscore","backbone","marionette","./base","./core"],function(e,t,i,a,s,n){var o=a.ItemView.extend({tagName:"label",className:"checkbox",template:"export/option"}),r=s.EmptyView.extend({message:"No exporters available."}),l=a.CollectionView.extend({itemView:o,emptyView:r}),c=a.ItemView.extend({template:"export/progress",ui:{status:"[data-target=status]",cancel:"[data-target=cancel]"},events:{"click @ui.cancel":"cancel"},modelEvents:{"change:status":"renderStatus"},getCookieName:function(){return"export-type-"+this.model.get("type")},getExportUrl:function(){var e=this.model.get("href");return"/"!==e.charAt(e.length-1)&&(e+="/"),e+(this.model.get("pages")||"")},initialize:function(){var t=this.getCookieName(),i=this.getExportUrl();this.iframe=e("<iframe />").attr("src",i).css("display","none"),this.model.set({url:i,cookie:t,status:"pending",time:0})},start:function(e){if("canceled"!==this.model.get("status")){n.utils.setCookie(this.model.get("cookie"),null),this.$el.append(this.iframe);var t=this,i=setInterval(function(){t.check()},e.monitorDelay);this.model.set({interval:i,status:"loading"})}},cancel:function(){var e=this.model.get("cookie"),t=this.model.get("interval");clearInterval(t),n.utils.setCookie(e,null),this.iframe.remove(),this.model.set("status","canceled")},check:function(){var e=this.model.get("cookie"),t=this.model.get("time"),i=this.model.get("interval");t+=this.monitorDelay,"complete"===n.utils.getCookie(e)?(clearInterval(i),n.utils.setCookie(e,null),this.model.set("status","complete")):t>=this.options.monitorTimeout?(clearInterval(i),this.model.set("status","timeout")):this.checkError()&&(clearInterval(i),this.model.set("status","error"))},checkError:function(){return this.iframe[0].document?0!==this.iframe.contents()[0].body.children.length:!1},renderStatus:function(e,t){var i;switch(t){case"error":i='<span class="label label-important">Error</span>';break;case"timeout":i='<span class="label label-warning">Request Timed Out</span>';break;case"complete":i='<span class="label label-success">Complete</span>';break;case"loading":i='<div class="label label-info"><i class="icon-spinner icon-spin"></i> Downloading...</span>';break;case"canceled":i='<span class="label label-warning">Canceled</span>'}this.ui.cancel.hide(),this.ui.status.html(i),this.model.set("done",!0)}}),h=a.CompositeView.extend({className:"export-batch",template:"export/batch",itemView:c,start:function(){var e=this.options;this.children.each(function(i,a){t.delay(function(){i.start(e)},a*e.requestDelay)})},finish:function(){var e=this;this.$el.html('<h3><i class="icon-ok-sign text-success" /> Export Done</h3>').css("text-align","center"),t.delay(function(){e.$el.slideUp({duration:300,easing:"easeInOutQuad",complete:function(){e.close()}})},2e3)}}),g=/^[0-9]+(\.\.\.[0-9]+)?$/,u=a.Layout.extend({template:"export/dialog",id:"exporter-dialog",className:"modal hide",options:{requestDelay:500,monitorDelay:200,monitorTimeout:6e5},ui:{pageOption:"[name=pages]",pageRange:"[name=page-range]",error:"[data-target=error]",save:"[data-toggle=save]"},events:{"click @ui.save":"exportData","click @ui.pageOption":"togglePageOption"},regions:{types:"[data-target=types]",progress:"[data-target=progress]"},initialize:function(){if(this.data={},!(this.data.exporters=this.options.exporters))throw new Error("exporters collection required")},open:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},onRender:function(){this.$el.modal({show:!1});var e=new l({collection:this.data.exporters});this.types.show(e)},togglePageOption:function(){this.ui.pageRange.prop("disabled",!this.pageRangeSelected())},getSelectedOptions:function(){return this.types.currentView.$(":checked").map(function(){return this.value})},getPageRange:function(){return this.pageRangeSelected()?this.ui.pageRange.val():void 0},pageRangeSelected:function(){return"range"===this.ui.pageOption.filter(":checked").val()},isPageRangeValid:function(){return g.test(this.getPageRange())},exportData:function(){this.ui.error.hide();var e=this.getSelectedOptions();if(0===e.length)return void this.ui.error.html("An export type must be selected.").show();if(this.pageRangeSelected()&&!this.isPageRangeValid())return void this.ui.error.html("The page range entered is invalid. It must be a single page, e.g. 1, or a range of pages, e.g. 2...5.").show();this.ui.save.prop("disabled",!0);var a,s=this,n=t.map(e,function(e){return a=s.data.exporters.get(e).toJSON(),a.pages=s.getPageRange(),a}),o=new i.Collection(n);this.listenTo(o,"change:status",function(){o.where({done:!0}).length===o.length&&(this.stopListening(o),this.ui.save.prop("disabled",!1),t.delay(function(){r.finish()},1e3))});var r=new h(t.extend({collection:o},this.options));this.progress.show(r),r.start()}});return{ExporterDialog:u}});
//# sourceMappingURL=exporter.js.map